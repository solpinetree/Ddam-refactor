<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>크루 탐색</title>

    <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,700|Open+Sans" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles-merged.css}">
    <link rel="stylesheet" th:href="@{/css/style.min.css}">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <link rel="stylesheet" th:href="@{/font-awesome/css/font-awesome.min.css}">   <!-- font awesome 4 -->
</head>

<head th:replace="include/common::iconstyle"></head>

<body>

<div class="probootstrap-page-wrapper">

    <!-- header -->
    <div th:replace="include/header::header"></div>
    <!--  nav bar -->
    <div th:replace="include/header::nav"></div>

    <section
            class="probootstrap-section probootstrap-section-colored probootstrap-bg probootstrap-custom-heading probootstrap-tab-section"
            style="background-image: url(/img/meetup2.png); width:1200px !important; height:350px !important;">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center section-heading probootstrap-animate">
                    <h2 class="mb0">크루 모집</h2>
                </div>
            </div>
        </div>
        <div sec:authorize="isAuthenticated()" class="probootstrap-tab-style-1">
            <ul class="nav nav-tabs probootstrap-center probootstrap-tabs no-border">
                <li class="active"><a data-toggle="tab" href="#crewListUp">크루 탐색</a></li>
                <li><a data-toggle="tab" href="#crewOpenChat">오픈 채팅</a></li>
            </ul>
        </div>
        <div sec:authorize="isAnonymous()" class="probootstrap-tab-style-1">
            <ul class="nav nav-tabs probootstrap-center probootstrap-tabs no-border">
                <li class="active"><a data-toggle="tab" href="#crewListUp">크루 탐색</a></li>
                <li><a href="" onClick="alert('로그인 후에 이용해주세요!')">오픈 채팅</a></li>
            </ul>
        </div>
    </section>


    <section class="probootstrap-section probootstrap-section">
        <div class="container">
            <div class="row">
                <div class="col-md-12">

                    <div class="tab-content">

                        <div id="crewListUp" class="tab-pane fade in active">
                            <!-- data display section -->
                            <section class="probootstrap-section" id="probootstrap-counter">
                                <div class="container" style="text-align:center;">

                                    <div class="row">
                                        <div class="col-md-3 col-sm-6 col-xs-6 col-xxs-12 probootstrap-animate">
                                            <div class="probootstrap-counter-wrap">
                                                <div class="probootstrap-icon">
                                                    <i class="icon-users2"></i>
                                                </div>
                                                <div class="probootstrap-text">
				                  <span class="probootstrap-counter">
				                    <span class="js-counter" data-from="0" th:attr="data-to=${#lists.size(crewList)}"
                                          data-speed="2500" data-refresh-interval="50">1</span>
				                  </span>
                                                    <span class="probootstrap-counter-label">누적 크루 수</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-6 col-xs-6 col-xxs-12 probootstrap-animate">
                                            <div class="probootstrap-counter-wrap">
                                                <div class="probootstrap-icon">
                                                    <i class="icon-user-tie"></i>
                                                </div>
                                                <div class="probootstrap-text">
				                  <span class="probootstrap-counter">
				                    <span class="js-counter" data-from="0" th:attr="data-to=${userCount}"
                                          data-speed="2500" data-refresh-interval="50">1</span>
				                  </span>
                                                    <span class="probootstrap-counter-label">누적 회원 수 </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="clearfix visible-sm-block visible-xs-block"></div>
                                        <div class="col-md-3 col-sm-6 col-xs-6 col-xxs-12 probootstrap-animate">
                                            <div class="probootstrap-counter-wrap">
                                                <div class="probootstrap-icon">
                                                    <i class="icon-library"></i>
                                                </div>
                                                <div class="probootstrap-text">
				                  <span class="probootstrap-counter">
				                    <span class="js-counter" data-from="0" th:attr="data-to=${meetupCount}"
                                          data-speed="2500" data-refresh-interval="50">1</span>
				                  </span>
                                                    <span class="probootstrap-counter-label">누적 모임 횟수</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-6 col-xs-6 col-xxs-12 probootstrap-animate">

                                            <div class="probootstrap-counter-wrap">
                                                <div class="probootstrap-icon">
                                                    <i class="icon-smile2"></i>
                                                </div>
                                                <div class="probootstrap-text">
				                  <span class="probootstrap-counter">
				                    <span class="js-counter" data-from="0" data-to="100" data-speed="5000"
                                          data-refresh-interval="50">1</span>%
				                  </span>
                                                    <span class="probootstrap-counter-label">모임 만족도</span>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </section>
                            <!-- data display section 끝-->

                            <!--  크루 리스트 보여주는 section -->
                            <section class="probootstrap-section">
                                <div class="container">
                                    <div class="row">
                                        <div th:each="crew:${crewList}">
                                            <!--  하나의 크루 -->

                                            <div style="cursor:pointer"
                                                 th:onclick="'location.href=\'' + @{/crew/crew-detail/{id}(id=${crew.id})} +'\''">
                                                <!--         <div class="col-md-6"> -->
                                                <div class="probootstrap-service-2 probootstrap-animate">
                                                    <div class="image">
                                                        <div class="image-bg">
                                                            <!--  <span th:text="${crew.filePath}"></span>-->
                                                            <img th:src="@{${crew.filePath}}"
                                                                 alt="Free Bootstrap Template by ProBootstrap.com">
                                                        </div>
                                                    </div>
                                                    <div class="text">
                                                        <h3 th:text="${crew.name}" style="font-weight:bold;">크루 이름</h3>
                                                        <span class="probootstrap-meta"
                                                              th:text="${crew.area}"></span><br>
                                                        <span class="probootstrap-meta"
                                                              th:text="${crew.category}"></span><br>
                                                        <span class="probootstrap-meta">크루장 : [[${crew.crewAdmin.username}]]</span><br>
                                                        <!--   	 <span class="probootstrap-meta">누적 모임 횟수 : </span><br>  -->
                                                        <p><span class="enrolled-count">멤버 수 : [[${crew.memberCount}]]  /  [[${crew.memberLimit}]]</span>
                                                        </p>
                                                        <span class="probootstrap-meta"><i class="fa fa-heart"
                                                                                           aria-hidden="true">&nbsp;[[${crew.likesCount}]]</i></span>
                                                    </div>
                                                </div>
                                                <!--    </div> -->
                                            </div>

                                            <!-- 하나의 크루 끝 -->
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!--  크루 리스트 보여주는 section 끝 -->
                        </div>
                        <!-- crewListUp div끝 -->

                        <!--  crewOpenChat 시작 -->
                        <div id="crewOpenChat" class="tab-pane fade">
                            <div class="chat-page">
                                <div class="msg_view" id="msgDiv"
                                     style="overflow-y:scroll; width:80%; margin:auto; height:500px; padding:4px; border:1 solid #000000;"></div>
                                <!-- 여기에 msg view가 나타남 ajax로! -->
                                <div id="msg_input" sec:authorize="isAuthenticated()"><br><br>
                                    <form id="chatinput" name="chatinput">
                                        <input type="hidden" name="writerId" th:value="${#authentication.principal.id}">
                                        <div style=" margin-left:60%;">
                                            <input type="text" name="message" class="textiiii" placeholder="메시지 보내기..."
                                                   style="text-align:center; width:70%;" required>
                                            <button type="button" id="chatbtn" class="btn btn-primary">보내기</button>
                                        </div>
                                    </form>
                                    <script th:inline="javascript">
                                        var id = '[[${#authentication.principal.id}]]';

                                        $("#chatinput").keypress(function (event) {
                                            if (event.which == 13) {
                                                $('#chatbtn').click();
                                                return false;
                                            }
                                        });

                                        $('#chatbtn').click(function () {
                                            var insertData = $('#chatinput').serialize();
                                            chatInsert(insertData);
                                        });

                                        function chatInsert(insertData) {

                                            $.ajax({
                                                url: '/chat/insert',
                                                type: 'post',
                                                data: insertData,
                                                success: function (data) {
                                                    if (data == 1) {
                                                        chatlist();
                                                        // 메시지를 보내면 메시지 입력창은 초기화
                                                        $('.textiiii').val('');
                                                    }
                                                }
                                            });
                                        }

                                        function chatlist() {

                                            $.ajax({
                                                url: '/chat/list/' + id,
                                                type: 'post',
                                                async: true,
                                                data: {'id': id},
                                                success: function (data) {
                                                    var a = '';
                                                    $.each(data, function (key, value) {
                                                        var time = moment(value.writetime).format('MM/DD HH:mm')

                                                        if (value.writer.id == id) { // 보낸건 오른쪽에
                                                            a += '<div class="sasa" align="right">';
                                                            a += '<span><b>' + value.writer.name + '</b></span><br>';
                                                            a += '<span style="color:black;">' + value.content + '</span><br>';
                                                            a += '<span style="font-size:3px;">' + time + '</span>';
                                                            a += '</div>';
                                                        } else { // 받은건 왼쪽
                                                            a += '<div class="hmhm" align:"left">';
                                                            a += '<span><b>' + value.writer.name + '</b></span><br>';
                                                            a += '<span style="color:black;">' + value.content + '</span><br>';
                                                            a += '<span style="font-size:3px;">' + time + '</span>';
                                                            a += '<br /></div>';
                                                        }
                                                    });
                                                    $('.msg_view').html(a);
                                                    $('#msgDiv').scrollTop($('#msgDiv')[0].scrollHeight);
                                                }
                                            });
                                        }


                                        $(document).ready(function () {
                                            $('#msgDiv').scrollTop($('#msgDiv')[0].scrollHeight);	// 페이지  리로딩 되었을 때 스크롤을 맨 밑을 보여줌
                                            setInterval(chatlist, 1000); //렉이 걸리면 초를 늘리자..!
                                        });
                                    </script>
                                </div>
                            </div>
                        </div>
                        <!--  crewOpenChat 끝 -->

                    </div>
                </div>
            </div>
        </div>
    </section>


    <!--  크루 생성하기 버튼 -->
    <section class="probootstrap-cta">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h2 class="probootstrap-animate" data-animate-effect="fadeInRight">당신의 운동 파트너를 찾아보세요!</h2>
                    <a href="newcrew" role="button"
                       class="btn btn-primary btn-lg btn-ghost probootstrap-animate"
                       data-animate-effect="fadeInLeft">크루 개설하기</a>
                </div>
            </div>
        </div>
    </section>


    <!-- footer -->
    <div th:replace="include/footer :: footer"></div>

</div>
<!-- END wrapper -->

<script th:src="@{/js/scripts.min.js}"></script>
<script th:src="@{/js/main.min.js}"></script>

</body>
</html>